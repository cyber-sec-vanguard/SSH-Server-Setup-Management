# SSH Server Setup and Management
In this project, I will set up an SSH server, and manage it. I will do my best to document everything -unlike me other projects. Eventually, I will try to automate this setup and management, resulting in another DevSecOps project.\n

First things first, I will setup an SSH server on my virtual machine.'n

## Documentation
## Server Simple Configuration
We will play with the `ssh_config` file, located in `/etc/ssh`. Back it up: `cp sshd_config sshd_config,old`.\n
I won't get into all keywords, some are obvious, such as `Protocol 2`.\n
### Matches
The config file is global, and works for all users, until it finds a `Match` keyword. Once it encounters that key, it will verify whether the match is satisfied. If no, it skips to the next match, and reverify. If it doesn't match any, it exits the config file. If it matches one, everything that is listed bellow it will be applied, until it reaches the end of the file, or encounters another `Match`.\n
    You can match many things, including the username, the group, the IP address, or the three of them. If you want it to match one key with many values, separate the values with commas, like this\n
`Match User lotfi, ahmad, oussama`\n
    `PasswordAuthentication no`\n
    Matches can stack up. If one matches (say) the username, and the other matches the IP address, then that user will have the configuration from the two blocs.\n
`Match User lotfi`\n
    `X11Forwarding yes`\n
`Match Group hacker_man`\n
    `PasswordAuthentication yes`\n
If a user is guteshel, from the group hacker_man, then he can have X forwarding, and authenticate using his passwd.\n
You want to use this to control clients' behaviour, including intruders.\n
### Banner
Banners can serve as a legal notice for intruders. They are displayed before login.\n
    Alternatively, you may use Message Of The Day, or MOTD, a banner that is displayed post login.\n
`Banner         /etc/ssh/banner # Edit this file and enter the message you want.`\n
`PrintMotd      yes # yes | no.`\n
### Password Attempts
If you have to use passwords, control how this feature is used.\n
`LoginGraceTime 30s     # The pre-authentication timeout. You can use 'm' instead. It is set to 2m by default.`\n
`MaxAuthTries   3       # It is set to 6 by default.`\n
### Verify Login with DNS
It is good to make sshd check wether both the hostname and the IP address match using a DNS server. If the result is positive, sshd allows the connection. Otherwise, it denies it.\n
    It can be expensive to maintain a local DNS, and is vulnerable to DNS cach poisoning. Using the ISP's DNS is even more expensive. It may be better to maintain a local DNS and use it securily. But it may not be ideal to use a solution that does not scale, what if your company grows to have 400 different machine? How will you maintain the DNS?\n
`UseDNS yes`\n
### Logging
Select what type of logging you want. 'Auth' means authentication related logs. There are other options. One of them is USER records messages generated by the user apps or activities.\n
`SysLogFacility  Auth`\n
`LogLevel        INFO            # The log level. Some levels violate privacy. This one logs`\n
`   # login and logoff problems.`\n
### Ciphers and MACs
I really disliked the default ciphers. Ross Anderson stated in his book that many libraries and tools have unsafe defaults.
`Cipher  aes128-gcm@openssh.com, aes256-gcm@openssh.com, aes128-ctr, aes192-ctr, aes256-ctr, aes128-cbc, aes192-cbc, aes256-cbc`\n
`MACs    hmac-sha2-512, hmac-sha2-256, umac-128@openssh.com, umac-64@openssh.com # I did not study`\n
`   # study UMAC, IDK whther it is good.`
### Service Denial Countermeasures
We will use three things to counter them:\n
    1. Short timeout for unauthorized sessions. Discussed already.
    2. Throttelling password attempts. Discussed already.
    3. Random Early Drop. Discussed now.
When using RED, if a certain number of unauthorized connections are up (let's call it the Threshold), then all next connections will have a chance of getting rejection. As the number of connections grow, the chance of rejection grows. If it reaches a max limit, all new attemps will fail.\n
This gives the IT team a chance to log onto the SSH server and deals with the attack.\n
`MaxStratups     10:30:100       # LowerLimit : InitialRejectionChance : MaxLimit`\n
Veros: if there are more than ten unauthorized connections, start rejecting with a chance of 30%. If there are one hundred connection, reject all other connections.\n
### Restricting Access by User or Group
Groups == roles.\n
Clients may need to use a server, but they don't need SSH access. Use this feature to allow certain groups in, or deny certain groups from accessing. You can use AllowX and DenyX in two ways: allow everyone and block some, or block all but allow some. In the former, you use DenyUser and DenyGroup. In the latter, you use AllowUser and AllowGroup. These keys can take more than one value, separated by commas.\n
`AllowGroups    sec, devs, admins   # Allow only users that belong to one of these three groups`\n
It is best practice to use groups. Ideally, you wan't to lower the chances of failure. Groups help you lower them.\n
Additionally, consider using IP blocking plug-ins, or packet filters. Use these to create an MLS system.\n
Consider using a sandbox, like Linux's 'seccomp'.\n
### Loging in as root
This is not idea. If someone logs in as regular user and uses root powers, it will be logged. If a user logs in as root, nothing will be logged (according to the book, at least. It may have changed by now). This is undesirable, mostly.\n
`PermitRootLogin    no`\n
`PermitRootLogin    forced-commands-only   # Forbids scrips`\n
### Chrooting
When you create a chroot directory, configure ssh to log the user onto its `/` chroot directory, not its `/home/username/` chroot directory.\n
Match   User    username
ChrootDirectory /usr/prisonroot/home/username
Next, make sure that the username is in `/etc/passwd` chroot file. If not, add it.\n
Next, set the right perms for the `/home/username/` chroot dir.\n
This may be my favourite SSH feature.\n
## Configure Client
To connect to a different username than yours, use username@hostname, where username is the username you want to connect to, and hostname is the server's name. This works too for SFTP, and SCP. To make the changes permanent, note them down on ssh_config. The three programs read from this file.
### File management
#### SCP
For Secure Copy Protocol, or SCP, the syntax is `scp source:path/to/file destination:/patho/to/file`. the source can be a name or an IP address. If the destination is not specified, it will copy it into the user's home directory.
#### SFTP
The SSH File Transfer Protocol, or SFTP, is more flexible. It allows you to manage files. SFTP is not FTP over SSH or SSL. But their commands are identical. Use `put` to post, `get` to get, `reget` to resume getting after internet blackout, it won't check for integrity, though. Use `cd` for the host, and `lcd` for the client, the l is probably for local.
### Configure SCP and SFTP in ssh_config
The SCP must be on the system's default $PATH. If it is present, SCP is on.
OpenSSH comes with an SFTP server. The entry is sufficient to activate SFTP. You can set up a client to have no access but SFTP access, to allow them to copy files around. This is compatible with chroot. Such a user will only need two entries: `ForceCommand internal-sftp` and `AllowTcpForwarding no`. This will force the user -after a match- to use one command: sftp.
To stop them from copying files around, you must create a chroot with no files. They can still copy files to it though. There isn't any real way to totally block them.
